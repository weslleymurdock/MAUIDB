name: CI

on:
  pull_request:

jobs:
  build:
    name: Build (net8 artifacts)
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore LiteDB.sln

      - name: Build
        run: dotnet build LiteDB.sln --configuration Release --no-restore /p:DefineConstants=TESTING

      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: net8-build
          if-no-files-found: error
          path: |
            LiteDB/bin/Release
            LiteDB/obj
            LiteDB.Tests/bin/Release
            LiteDB.Tests/obj

  test:
    name: Test on SDK ${{ matrix.dotnet-version }}
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      DOTNET_ROLL_FORWARD: Major
    strategy:
      matrix:
        include:
          - dotnet-version: 6.0.x
            quality: ga
          - dotnet-version: 7.0.x
            quality: ga
          - dotnet-version: 8.0.x
            quality: ga
          - dotnet-version: 9.0.x
            quality: preview
          - dotnet-version: 10.0.x
            quality: preview

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install matrix SDK
        if: matrix.dotnet-version != '8.0.x'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}
          dotnet-quality: ${{ matrix.quality }}

      - name: Download build outputs
        uses: actions/download-artifact@v4
        with:
          name: net8-build
          path: .

      - name: Run tests without rebuilding
        run: dotnet test LiteDB.Tests/LiteDB.Tests.csproj --configuration Release --no-build --verbosity normal --settings tests.runsettings --logger "trx;LogFileName=TestResults.trx" --logger "console;verbosity=detailed" /p:DefineConstants=TESTING

      - name: Summarize test results
        if: always()
        run: |
          python - <<'PY'
          import xml.etree.ElementTree as ET
          from pathlib import Path

          trx_dir = Path('LiteDB.Tests/TestResults')
          candidates = sorted(trx_dir.glob('*.trx'), key=lambda p: p.stat().st_mtime, reverse=True)
          if not candidates:
              raise SystemExit('No TRX files were produced by dotnet test')

          latest = candidates[0]
          ns = {'t': 'http://microsoft.com/schemas/VisualStudio/TeamTest/2010'}
          root = ET.parse(latest).getroot()
          counters = root.find('.//t:Counters', ns)
          if counters is None:
              raise SystemExit('TRX file is missing Counters data')

          total = int(counters.get('total', 0))
          executed = int(counters.get('executed', 0))
          passed = int(counters.get('passed', 0))
          failed = sum(int(counters.get(key, 0)) for key in ('failed', 'error', 'timeout', 'aborted'))
          skipped = total - executed

          print(f'Test summary ({latest.name}): total={total}, passed={passed}, failed={failed}, skipped={skipped}')
          PY
