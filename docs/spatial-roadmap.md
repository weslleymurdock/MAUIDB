# Spatial Indexing & Geometry Roadmap

## Current State (feat/spatial-C1)

### Architecture Overview
- **Spatial entry point**: LiteDB/Spatial/Spatial.cs centralises mapper registration, Morton `_gh` computation, `_mbb` bounding boxes, and helper APIs (`EnsurePointIndex`, `EnsureShapeIndex`, `Near`, `WithinBoundingBox`, `Within`, `Intersects`, `Contains`).
- **Geometry primitives**: LiteDB/Spatial/GeoShape.cs defines immutable GeoPoint, GeoLineString, and GeoPolygon types that normalise coordinates and validate rings; each exposes a GeoBoundingBox.
- **Geometry engine**: LiteDB/Spatial/Geometry.cs supplies containment/intersection logic (point-in-polygon, segment intersection, hole validation) with numeric tolerance of 1e-9 degrees.
- **GeoJSON layer**: LiteDB/Spatial/GeoJson.cs serialises/deserialises supported shapes, enforces default WGS84 CRS, and raises LiteException on unsupported payloads.
- **Math helpers**: LiteDB/Spatial/GeoMath.cs implements Haversine and simplified Vincenty distances, polar stability handling, and bounding boxes for circles.
- **Index support**: `_gh` holds Morton (Z-order) codes generated by LiteDB/Spatial/SpatialIndexing.cs; `_mbb` stores `[minLat, minLon, maxLat, maxLon]` arrays produced from GeoBoundingBox/LongitudeRange with anti-meridian awareness.
- **Mapper integration**: Computed members are injected through LiteCollection<T>.EntityMapper, ensuring every LiteCollection<T> instance projects `_gh`/`_mbb` without per-collection state.

### Behaviour & Tests
- Coverage resides in LiteDB.Tests/Spatial/SpatialTests.cs (distance ordering, antimeridian bounding boxes, polygon holes, line/polygon intersections, `_gh` recomputation, GeoJSON round-trip, coordinate validation).
- Manual verification command:
```
dotnet test LiteDB.Tests/LiteDB.Tests.csproj -f net8.0 --filter FullyQualifiedName~Spatial --no-restore
```
  Result: 12 spatial tests passed (warnings stem from legacy crypto APIs and nullable annotations elsewhere).

### Strengths
- Unified serialization path bound to the active BsonMapper (supports multiple LiteDatabase instances).
- Strict geometry validation prevents malformed shapes and enforces hole semantics.
- Morton hashing and bounding boxes lay groundwork for indexed searches.
- Anti-meridian safe longitude handling via LongitudeRange and GeoBoundingBox.

### Limitations
- Helper methods still scan entire collections; `_gh` and `_mbb` are not yet used to prune candidates.
- No LINQ or BsonExpression integration for spatial predicates.
- Index precision is static per creation; no adaptive refinement during queries.
- Only 2D geometries supported; altitude/3D requirements unresolved.
- No spatial join operators or nearest-neighbour optimisations beyond brute-force filtering.
- Lacks tooling for retrofitting existing collections with spatial indices.

## Roadmap

### 1. Index-Aware Query Execution (Delivered)
- Circle and polygon queries now materialise `_gh` range windows through `SpatialIndexing.GetMortonRanges` and apply `_mbb` intersection checks via `SPATIAL_MBB_INTERSECTS`.
- `Spatial.Near`, `Within`, `Intersects`, and `Contains` issue targeted `Query` pipelines instead of enumerating `FindAll()`, honouring Morton index scans automatically.
- BenchmarkDotNet coverage (`SpatialNearBenchmark`) tracks the delta between brute-force scans and the indexed implementation.

### 2. LINQ & Expression Support (Delivered)
- `$near`, `$within`, `$within_box`, `$intersects`, and `$contains` are exposed as `SPATIAL_*` expression methods for the BsonExpression engine.
- `SpatialExpressions` enables LINQ scenarios (`collection.Query().Where(...)`) that translate into the new operators via a dedicated LINQ resolver.

### 3. 3D & Extended Geometry
- Design GeoPoint3D / GeoBoundingBox3D / GeoPolyhedron structures.
- Evaluate 3D Morton hashing and mixed distance metrics.
- Provide opt-in configuration to preserve backward compatibility with 2D collections.

### 4. Precision & Options (Delivered)
- `SpatialOptions` exposes defaults for index precision, bounding-box padding, and distance tolerances.
- Precision metadata is written to `_spatial_indexes` when `EnsurePointIndex` executes and reloaded on demand for subsequent sessions.

### 5. Migration & Tooling
- Offer shell commands or utility APIs to backfill `_gh`/`_mbb` for existing datasets.
- Document migration paths and antimeridian edge cases.

### 6. Performance Tracking (Delivered)
- `SpatialNearBenchmark` contrasts brute-force scans with the index-aware pipeline across multiple dataset sizes, reporting allocation and runtime metrics.

### 7. Documentation & Samples (Delivered)
- `docs/spatial-getting-started.md` provides an end-to-end quickstart, LINQ examples, and a minimal HTTP sample for radius searches.
- Roadmap sections now reflect available operators and links to the benchmark suite for validation.

## Open Questions
- Should `_gh`/`_mbb` remain internal fields or become part of the public query DSL?
- How to guarantee recomputation when the engine is used directly (bypassing LiteCollection<T>)?
- Is the default 52-bit Morton precision sufficient globally, or do we need latitude-aware precision tuning?
- How should spatial helpers interact with transactions and existing query plans?

## Immediate Action Items
1. Draft design for index-backed Near/Within queries including engine hooks.
2. Prototype `_gh` range generation and anti-meridian splitting utilities.
3. Decide on migration tooling scope (shell command vs. programmatic API).
4. Capture current brute-force performance baselines for comparison.

## Test & Validation Log
- 2025-09-28: `dotnet test LiteDB.Tests/LiteDB.Tests.csproj -f net8.0 --filter FullyQualifiedName~Spatial --no-restore`
  - 12 tests passed, 0 failed.
  - Warnings: existing nullable annotations, legacy AES PBKDF2 usage, CA2200 rethrows (unchanged by spatial work).

---

Revisit this roadmap after each milestone (index-aware queries, LINQ support, 3D extensions) to track progress and adjust priorities.
